<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Anatomy Stressors Q-Sort</title>
<style>
:root{--gap:10px;--card-pad:10px;--col-w:180px}

/* Base layout */
body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:20px}
h1{margin:0 0 6px 0;font-size:22px}
.sub{color:#555;margin:0 0 14px 0}
.wrap{display:flex;flex-direction:row;align-items:flex-start;gap:20px}
.left{flex:0 0 45%;max-width:45%;max-height:75vh;overflow:auto;padding-right:8px}
.right{flex:1 1 55%;max-width:55%;display:flex;flex-direction:column;align-items:flex-start}
@media(max-width:900px){.wrap{flex-direction:column}.left,.right{max-width:100%;flex:0 0 auto}}

/* Pools & grids */
.pool,.grid{border:1px solid #ddd;border-radius:8px;padding:12px;background:#fafafa}
.pool{min-height:120px}

/* üîÅ Unsorted statements: exact two columns (CSS-only) */
.cards{
  display:grid;
  grid-template-columns:repeat(2, minmax(0, 1fr));
  gap:var(--gap);
}
.card{
  background:#fff;border:1px solid #ddd;border-radius:8px;padding:var(--card-pad);
  cursor:grab;user-select:none;box-shadow:0 1px 2px rgba(0,0,0,.05)
}
.card:active{cursor:grabbing}
@media(max-width:600px){
  .cards{grid-template-columns:1fr;}
}

/* Sort grid */
.grid{overflow-x:hidden;overflow-y:auto}
.grid-sticky{position:sticky;top:0;background:#f5faff;border:1px solid #d6e6ff;
padding:8px 10px;border-radius:6px;font-size:13px;margin-bottom:10px}
.grid-sticky b{font-weight:700}
.rows{display:flex;flex-direction:column;gap:25px}
.row-label{text-align:center;font-weight:600;font-size:14px;color:#444;margin:4px 0}

/* üîí Keep each row on one line; side-scroll if needed */
.row-cols{
  display:flex;
  gap:var(--gap);
  justify-content:flex-start;   /* was center */
  flex-wrap:nowrap;             /* no wrapping; keeps +1‚Üí+4 and 0‚Üí‚àí4 each on a single line */
  overflow-x:auto;              /* horizontal scroll on smaller screens */
  padding-bottom:6px;
  scroll-snap-type:x mandatory; /* nice snapping */
}

/* Columns inside rows */
.col{
  flex:0 0 var(--col-w);        /* fixed basis so four columns sit in one horizontal strip */
  min-height:240px;background:#fff;border:1px dashed #bbb;
  border-radius:8px;padding:8px;display:flex;flex-direction:column;gap:8px;
  max-height:65vh;overflow-y:auto;scroll-behavior:smooth;
  scroll-snap-align:start;
}
.col.dragover{background:#f0f7ff;border-color:#5a9bff}

/* Slightly shrink columns on narrower screens so they often fit without scrolling */
@media (max-width:1200px){ :root{ --col-w:160px } }
@media (max-width:992px){  :root{ --col-w:150px } }

/* On very small screens, allow columns to be full width but still in a single horizontal row via var(--col-w) */
@media(max-width:600px){
  :root{ --col-w:320px }  /* adjust as desired; keeps horizontal scroll rather than wrapping */
  .col{ max-height:45vh }
}

/* Optional: thinner horizontal scrollbar styling (WebKit) */
.row-cols::-webkit-scrollbar{height:8px}
.row-cols::-webkit-scrollbar-thumb{background:#cfd8ff;border-radius:8px}

/* Headers, badges, misc */
.col-head{display:flex;justify-content:space-between;align-items:center;margin:0 0 6px 0}
.badge{font-size:12px;padding:2px 6px;border-radius:999px;background:#eef4ff;border:1px solid #cfe0ff}
.tiny{font-size:12px;color:#666}
.row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:10px 0}

/* Buttons */
button{border:1px solid #1f7aed;background:#2a84ff;color:#fff;padding:10px 14px;border-radius:8px;
font-weight:600;cursor:pointer}
button:disabled{opacity:.5;cursor:not-allowed}

/* Notes + emphasis */
.note{background:#fff9e6;border:1px solid #ffe7a3;padding:10px;border-radius:8px}

/* Keep the slight background tints you had on first/last row groups */
.rows>.row-cols:first-of-type{background:#f4faff;border-radius:8px;padding:8px}
.rows>.row-cols:last-of-type{background:#fff7f7;border-radius:8px;padding:8px}
</style>
</head>

<body>
<h1>Anatomy Stressors Q-Sort</h1>
<p class="sub">
  Sort the 44 statements from <b>‚àí4 = least characteristic of my stress</b> to 
  <b>+4 = most characteristic</b>. Each column shows its required count‚Äîfill exactly.
</p>

<div class="wrap">
  <div class="left">

    <!-- üîπ PID first -->
    <div class="row" style="margin-top:0;">
      <label for="pidInput"><b>Participant ID:</b></label>
      <input id="pidInput" type="text" placeholder="e.g., AB123"
        style="padding:6px;margin:6px;border:1px solid #ccc;border-radius:4px" autofocus>
    </div>
    <p class="tiny" style="margin-top:-6px">
      Please create/enter a unique code with <b>two letters + three numbers</b> (e.g., AB123).
      You‚Äôll re-enter the same code in Qualtrics.
    </p>

    <!-- Unsorted statements + controls -->
    <div class="pool" style="margin-top:10px;">
      <div class="row">
        <strong>Unsorted Statements</strong>
        <span id="poolCount" class="badge">loading‚Ä¶</span>
      </div>
      <div id="pool" class="cards"></div>
      <p class="tiny">Drag cards into any column (you can move them back and forth).</p>
    </div>

    <div style="height:12px"></div>
    <div class="note tiny"><b>Tip:</b> If a column is full, drop is blocked.</div>

    <div class="row" style="margin-top:12px">
      <button id="downloadBtn" disabled>Download CSV</button>
      <span id="status" class="tiny">Place all cards to enable download.</span>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="jumpNeg">Go to 0 ‚Üí ‚àí4</button>
      <button id="jumpPos">Go to +1 ‚Üí +4</button>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="submitQualtricsBtn" disabled>Submit to Qualtrics</button>
    </div>

    <p style="margin-top:10px;font-weight:bold;color:#d9534f">
      ‚ö†Ô∏è After sorting all 44 statements, click <b>‚ÄúSubmit to Qualtrics‚Äù</b> to record your results.
    </p>
  </div>

  <div class="right">
    <div class="grid">
      <div class="grid-sticky">
        <b>How to rank:</b> The <b>upper row</b> holds <b>+1 to +4</b> (most characteristic).<br>
        The <b>lower row</b> holds <b>0 to ‚àí4</b> (neutral to least characteristic).<br>
        <span class="tiny">
          Tip: Start with the <b>lower row (0 ‚Üí ‚àí4)</b> first, then complete the upper row.
        </span>
      </div>
      <div id="gridRows" class="rows"></div>
    </div>
  </div>
</div>

<script>
const scaleLabels=[-4,-3,-2,-1,0,1,2,3,4];
const distribution=[3,4,5,6,8,6,5,4,3];
const csvPath='statements.csv';
let statements=[],placements={};

function el(t,a={},...c){const x=document.createElement(t);
Object.entries(a).forEach(([k,v])=>{if(k==='class')x.className=v;else if(k==='html')x.innerHTML=v;else x.setAttribute(k,v)});c.forEach(ch=>x.append(ch));return x;}

async function loadCSV(p){
  const r = await fetch(p);
  if(!r.ok) throw new Error('Cannot load statements.csv');
  const txt = await r.text();
  const rows = txt.trim().split(/\r?\n/);
  const out = [];
  for(let i=1;i<rows.length;i++){
    const line = rows[i];
    const idx = line.indexOf(',');
    if(idx < 0) continue;
    let id = line.slice(0, idx).trim();
    const text = line.slice(idx+1).trim();

    // Normalize: " 44", "044", "S44" -> "44"
    const num = parseInt(id.replace(/\D+/g,''), 10);
    if(!Number.isFinite(num)) continue;
    id = String(num);

    if(id && text) out.push({ id, text });
  }

  // Sanity check for missing IDs
  const ids = out.map(o => parseInt(o.id,10)).sort((a,b)=>a-b);
  const missing = [];
  for(let k=1;k<=ids.length;k++){
    if(!ids.includes(k)) missing.push(k);
  }
  if(missing.length){
    alert('Warning: Missing statement IDs: ' + missing.join(', '));
  }
  return out;
}

function updatePoolCount(){
  const n=Object.values(placements).filter(v=>v==='pool').length;
  document.getElementById('poolCount').textContent=n+' remaining';
}
function canDrop(i){return Object.values(placements).filter(v=>v===i).length<distribution[i];}
function allPlaced(){return Object.values(placements).every(v=>v!=='pool');}
function refreshButtons(){
  const r=allPlaced();
  downloadBtn.disabled=!r;
  submitQualtricsBtn.disabled=!r;
  status.textContent=r?'All set. You can download or submit.':'Place all cards to enable download/submit.';
}

function makeCard(s){
  const c=el('div',{class:'card',draggable:'true','data-id':s.id});c.textContent=s.text;
  c.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',s.id));
  return c;
}

function attachDnD(){
  const pool=document.getElementById('pool');
  pool.addEventListener('dragover',e=>{e.preventDefault();pool.classList.add('dragover')});
  pool.addEventListener('dragleave',()=>pool.classList.remove('dragover'));
  pool.addEventListener('drop',e=>{
    e.preventDefault();pool.classList.remove('dragover');
    const id=e.dataTransfer.getData('text/plain');
    const card=document.querySelector(`.card[data-id="${CSS.escape(id)}"]`);
    if(card){pool.append(card);placements[id]='pool';updatePoolCount();refreshButtons();updateBadges();}
  });
  document.querySelectorAll('.col').forEach((col,i)=>{
    col.addEventListener('dragover',e=>{if(canDrop(i)){e.preventDefault();col.classList.add('dragover');}});
    col.addEventListener('dragleave',()=>col.classList.remove('dragover'));
    col.addEventListener('drop',e=>{
      e.preventDefault();col.classList.remove('dragover');
      const id=e.dataTransfer.getData('text/plain');if(!canDrop(i))return;
      const card=document.querySelector(`.card[data-id="${CSS.escape(id)}"]`);
      if(card){col.append(card);placements[id]=i;updatePoolCount();refreshButtons();updateBadges();}
    });
  });
}

function updateBadges(){
  document.querySelectorAll('.col').forEach((col,i)=>{
    const have=col.querySelectorAll('.card').length;const need=distribution[i];
    const b=col.querySelector('.badge');if(b)b.textContent=`${have}/${need}`;
  });
}

function downloadCSV(){
  const header='id,rank\n';
  const lines=statements.map(s=>{
    const p=placements[s.id];
    const r=(typeof p==='number')?scaleLabels[p]:'';
    return `${s.id},${r}`;
  }).join('\n');
  const blob=new Blob([header+lines],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=el('a',{href:url,download:'qsort_results.csv'});
  document.body.append(a);a.click();a.remove();URL.revokeObjectURL(url);
}

(async function(){
  statements=await loadCSV(csvPath);
  statements.forEach(s=>placements[s.id]='pool');

  const grid=document.getElementById('gridRows');

  /* Upper row +1‚Üí+4 */
  const topLbl=el('div',{class:'row-label'},'Upper Row: Most Characteristic (+1 ‚Üí +4)');
  const top=el('div',{class:'row-cols',id:'rowPos'});
  for(let i=5;i<=8;i++){
    const l=scaleLabels[i];
    const h=el('div',{class:'col-head'},
      el('div',{},el('strong',{html:(l>0?'+':'')+l})),
      el('span',{class:'badge'},`0/${distribution[i]}`));
    const col=el('div',{class:'col','data-col':i},h);
    top.append(col);
  }
  grid.append(topLbl,top);

  /* Lower row 0‚Üí‚àí4 */
  const botLbl=el('div',{class:'row-label'},'Lower Row: Neutral to Least Characteristic (0 ‚Üí ‚àí4)');
  const bot=el('div',{class:'row-cols',id:'rowNeg'});
  [4,3,2,1,0].forEach(i=>{
    const l=scaleLabels[i];
    const h=el('div',{class:'col-head'},
      el('div',{},el('strong',{html:(l>0?'+':'')+l})),
      el('span',{class:'badge'},`0/${distribution[i]}`));
    const col=el('div',{class:'col','data-col':i},h);
    bot.append(col);
  });
  grid.append(botLbl,bot);

  /* fill pool */
  const pool=document.getElementById('pool');
  statements.forEach(s=>pool.append(makeCard(s)));
  updatePoolCount();attachDnD();updateBadges();

  /* jump buttons */
  jumpPos.onclick=()=>rowPos.scrollIntoView({behavior:'smooth'});
  jumpNeg.onclick=()=>rowNeg.scrollIntoView({behavior:'smooth'});

  /* autofill PID from Qualtrics URL, lock field */
  const params=new URLSearchParams(location.search);
  const pidParam=(params.get('pid')||'').toUpperCase();
  if(pidParam){
    pidInput.value=pidParam;
    pidInput.readOnly=true; // optional
  }

  downloadBtn.onclick=downloadCSV;

  /* return to Qualtrics */
  const BASE="https://shsu.co1.qualtrics.com/jfe/form/SV_9mLZQw7T45q9bcW?return=1";

 submitQualtricsBtn.onclick = () => {
  if(!allPlaced()){ alert("Please place all cards first."); return; }
  const pid = (pidInput.value||'').trim().toUpperCase();
  if(!pid){ alert("Enter Participant ID first."); return; }

  const u = new URL(BASE);
  u.searchParams.set('pid', pid);

  // Map S1..Sn using actual statement order
  for(let i=0; i<statements.length; i++){
    const s = statements[i];
    const p = placements[s.id];
    const r = (typeof p === 'number') ? scaleLabels[p] : '';
    u.searchParams.set('S' + (i+1), r);
  }

  // Optional console check
  console.log('Statements count:', statements.length);

  location.href = u.toString();
};
})();
</script>
</body>
</html>
